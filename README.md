# logstalker

Logstalker tails a variety of log files (nginx, rails) and streams each log
entry into Google BigQuery for further analysis.

## Requirements & Setup

The first thing you will need is a Google BigQuery account. The Google Cloud
project you're using must have the BigQuery permissions enabled.

In the BigQuery admin, create a new dataset to be used to store the log data.
Logstalker will need the Google `project_id` and the `dataset_id` passed as
arguments when you run it.

Finally, you'll need a JWT.json file which contains authentication information
required to connect to BigQuery through a service account.

To download this file, in the Google Cloud admin under `APIs & auth`, click on
`Credentials`. You should have a `Service Account` listed already; if not,
create one. Clicking on the email address of the service account will bring you
to a screen where you can generate & download a new `JSON key`. This JSON file
will need to be present on all the servers you run logstalker on.

## Usage

Nginx access logs:

    ./logstalker -jwt_filename=jwt.json -project_id=GOOGLE_PROJECT_ID -dataset_id=BIGQUERY_DATASET_ID -log_filename=/var/log/nginx/access.log -parser=nginx-access

Nginx error logs:

    ./logstalker -jwt_filename=jwt.json -project_id=GOOGLE_PROJECT_ID -dataset_id=BIGQUERY_DATASET_ID -log_filename=/var/log/nginx/error.log -parser=nginx-error

Rails logs (with `logstalker_rails` installed):

    ./logstalker -jwt_filename=jwt.json -project_id=GOOGLE_PROJECT_ID -dataset_id=BIGQUERY_DATASET_ID -log_filename=/srv/rails_app/shared/log/logstalker_production.log -parser=rails

## Nginx Access Log Formatting

The Nginx log format outputs log entries as JSON:

    log_format logstalker '{"ip":"$remote_addr", "timestamp":"$time_local",'
                          '"domain":"$http_host", "request":"$request", "status":$status,'
                          '"referrer":"$http_referer", "user_agent":"$http_user_agent",'
                          '"response_time":$request_time}';

    server {
        listen 80;
        root /srv/app/current/public;

        access_log /var/log/nginx/access.log logstalker;
        error_log /var/log/nginx/error.log error;
    }

Unfortunately Nginx does not support custom log formats for the error log, and
the error format is undocumented and frequently changing. Logstalker parses the
error log as best it can, but some information may be missing for certain errors.

## Rails Log Formatting

The default Rails production logs do not include a lot of information, so the
[logstalker_rails](https://github.com/mjp/logstalker_rails) gem exists to generate
more detailed logs suitable for logstalker.

## BigQuery Table Schema

Logstalker will create a table for every day of log data in order to save
cost in querying; table names are in the format `logs_YYYYMMDD`.

Column | Type | Description
:--- | :--- | :---
`service` | `STRING` | Service or app name. Empty by default, useful for aggregating logs from multiple apps at the same time.
`log_type` | `STRING` | The parser used (`nginx-access`, `nginx-error`, `rails`)
`host` | `STRING` | The hostname of the server that received the request
`timestamp` | `TIMESTAMP` | When the request was received
`ip` | `STRING` | IP address of the client
`domain` | `STRING` | The domain of the request
`method` | `STRING` | HTTP method (`GET`, `POST`, etc.)
`path` | `STRING` | The URI (`/request/path`)
`query` | `STRING` | `GET` params (`nginx`) or `GET`, `POST`, `PUT`, and `PATCH` params (`rails`)
`action` | `STRING` | `Controller#action` (`rails` only)
`message` | `STRING` | Error message if available
`status` | `INTEGER` | HTTP status code of the response
`referrer` | `STRING` | HTTP referrer
`user_agent` | `STRING` | User agent
`user_id` | `STRING` | User ID of the request (see below)
`response_time` | `FLOAT` | Response time in ms

## User Tracking

Sometimes it can be helpful to view the logs generated by a specific user.
Logstalker can associate log entries to a user ID, generally through a cookie.

### User tracking for Nginx access logs

Change the Nginx access log format to read from a cookie. Nginx cookie data
is read into the $cookie_NAME variable, ex: `$cookie_user_id` for the cookie
named `user_id`.

    log_format logstalker '{"ip":"$remote_addr", "timestamp":"$time_local",'
                          '"domain":"$http_host", "request":"$request", "status":$status,'
                          '"referrer":"$http_referer", "user_agent":"$http_user_agent",'
                          '"response_time":$request_time, "user_id": "$cookie_user_id"}';

### User tracking for Rails

You can configure the gem to read the user ID from a cookie or the session. 
For details see the [logstalker_rails](https://github.com/mjp/logstalker_rails)
readme.
